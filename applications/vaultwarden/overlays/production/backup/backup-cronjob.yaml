apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup
spec:
  suspend: false
  schedule: "0 3 * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never
          initContainers:
            - name: pg-dump
              image: postgres:16
              imagePullPolicy: IfNotPresent
              env:
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: vaultwarden-postgres-secret
                      key: username
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: vaultwarden-postgres-secret
                      key: password
              envFrom:
                - configMapRef:
                    name: pgdump-config
              command:
                - /bin/sh
                - -c
                - pg_dump --clean --blob --if-exists -F d -Z 9 -f /pg_dump/vaultwarden_$(date +'%d-%m-%Y')
              volumeMounts:
                - name: pg-dump-volume
                  mountPath: /pg_dump

          containers:
            - name: s3-eu-central-3-restic-backup
              image: ghcr.io/tryrocket-cloud/tryrocket-cloud:backup
              imagePullPolicy: Always
              envFrom:
                - configMapRef:
                    name: vaultwarden-config
                - secretRef:
                    name: ionos-s3-restic-secret
                - secretRef:
                    name: healthchecks-secret
              command:
                  - /bin/sh
                  - -c
                  - |
                    export RESTIC_VERSION=$(restic version | awk '{print $2}')

                    #curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/start

                    # Kubernetes, by default, uses the Pod name as the hostname, and since Pod names are random "no parent snapshot found, will read all files" occur as restic snapshots are distinguished by both path and host.
                    restic backup --host tryrocket.cloud --tag restic:$RESTIC_VERSION --tag vaultwarden:$VAULTWARDEN_VERSION /pg_dump /data
                    #curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?

                    restic check --read-data-subset 1/7
                    #curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?

                    restic forget --keep-daily 30 --keep-monthly 3 --keep-yearly 1 --prune
                    #curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?
              volumeMounts:
                - name: vaultwarden-rwx-storage
                  mountPath: /data
                  readOnly: true
                - name: vaultwarden-hetzner-subaccount-ssh-privatekey
                  mountPath: /root/.ssh/id_ed25519
                  readOnly: true
                  subPath: id_ed25519
                - name: vaultwarden-hetzner-subaccount-ssh-config
                  mountPath: /root/.ssh/config
                  readOnly: true
                  subPath: config
                - name: vaultwarden-hetzner-subaccount-ssh-hosts
                  mountPath: /root/.ssh/hosts
                  readOnly: true
                  subPath: hosts
                - name: pg-dump-volume
                  mountPath: /pg_dump
                  readOnly: true

            - name: ionos-objectstorage-eu-central-1-s3-restic-backup
              image: ghcr.io/tryrocket-cloud/tryrocket-cloud:backup
              imagePullPolicy: Always
              envFrom:
                - configMapRef:
                    name: vaultwarden-config
                - secretRef:
                    name: ionos-objectstorage-eu-central-1-s3-restic-secret
                - secretRef:
                    name: healthchecks-secret
              command:
                  - /bin/sh
                  - -c
                  - |
                    export RESTIC_VERSION=$(restic version | awk '{print $2}')

                    #curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/start

                    # Kubernetes, by default, uses the Pod name as the hostname, and since Pod names are random "no parent snapshot found, will read all files" occur as restic snapshots are distinguished by both path and host.
                    restic backup --host tryrocket.cloud --tag restic:$RESTIC_VERSION --tag vaultwarden:$VAULTWARDEN_VERSION /pg_dump /data
                    #curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?

                    restic check --read-data-subset 1/7
                    #curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?

                    restic forget --keep-daily 30 --keep-monthly 3 --keep-yearly 1 --prune
                    #curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?
              volumeMounts:
                - name: vaultwarden-rwx-storage
                  mountPath: /data
                  readOnly: true
                - name: vaultwarden-hetzner-subaccount-ssh-privatekey
                  mountPath: /root/.ssh/id_ed25519
                  readOnly: true
                  subPath: id_ed25519
                - name: vaultwarden-hetzner-subaccount-ssh-config
                  mountPath: /root/.ssh/config
                  readOnly: true
                  subPath: config
                - name: vaultwarden-hetzner-subaccount-ssh-hosts
                  mountPath: /root/.ssh/hosts
                  readOnly: true
                  subPath: hosts
                - name: pg-dump-volume
                  mountPath: /pg_dump
                  readOnly: true

            - name: fsn1-bx751-restic-backup
              image: ghcr.io/tryrocket-cloud/tryrocket-cloud:backup
              imagePullPolicy: Always
              envFrom:
# because of $VAULTWARDEN_VERSION
                - configMapRef:
                    name: vaultwarden-config
# TODO: move to secret
                - configMapRef:
                    name: restic-config
                - secretRef:
                    name: restic-secret
                - secretRef:
                    name: healthchecks-secret
              command:
                  - /bin/sh
                  - -c
                  - |
                    ssh-keyscan -p 23 -f /root/.ssh/hosts >> /root/.ssh/known_hosts

                    curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/start

                    export RESTIC_VERSION=$(restic version | awk '{print $2}')

                    # Kubernetes, by default, uses the Pod name as the hostname, and since Pod names are random "no parent snapshot found, will read all files" occur as restic snapshots are distinguished by both path and host.
                    restic backup --host tryrocket.cloud --tag restic:$RESTIC_VERSION --tag vaultwarden:$VAULTWARDEN_VERSION /pg_dump /data
                    curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?

                    restic check --read-data-subset 1/7
                    curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?

                    restic forget --keep-daily 30 --keep-monthly 3 --keep-yearly 1 --prune
                    curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?
              volumeMounts:
                - name: vaultwarden-rwx-storage
                  mountPath: /data
                  readOnly: true
                - name: vaultwarden-hetzner-subaccount-ssh-privatekey
                  mountPath: /root/.ssh/id_ed25519
                  readOnly: true
                  subPath: id_ed25519
                - name: vaultwarden-hetzner-subaccount-ssh-config
                  mountPath: /root/.ssh/config
                  readOnly: true
                  subPath: config
                - name: vaultwarden-hetzner-subaccount-ssh-hosts
                  mountPath: /root/.ssh/hosts
                  readOnly: true
                  subPath: hosts
                - name: pg-dump-volume
                  mountPath: /pg_dump
                  readOnly: true
          volumes:
            - name: vaultwarden-rwx-storage
              persistentVolumeClaim:
                claimName: vaultwarden-rwx-pvc
            - name: vaultwarden-hetzner-subaccount-ssh-privatekey
              secret:
                secretName: hetzner-subaccount-ssh-secret
                items:
                  - key: ssh-privatekey
                    path: id_ed25519
                defaultMode: 384
            - name: vaultwarden-hetzner-subaccount-ssh-config
              secret:
                secretName: hetzner-subaccount-ssh-secret
                items:
                  - key: ssh-config
                    path: config
                defaultMode: 384
            - name: vaultwarden-hetzner-subaccount-ssh-hosts
              secret:
                secretName: hetzner-subaccount-ssh-secret
                items:
                  - key: ssh-hosts
                    path: hosts
                defaultMode: 384
            - name: pg-dump-volume
              emptyDir: {}

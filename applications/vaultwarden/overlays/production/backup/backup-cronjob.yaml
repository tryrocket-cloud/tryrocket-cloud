apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup
spec:
  suspend: false
  schedule: "0 3 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never
          initContainers:
            - name: pg-dump
              image: postgres:16
              imagePullPolicy: IfNotPresent
              env:
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: vaultwarden-postgres-secret
                      key: username
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: vaultwarden-postgres-secret
                      key: password
              envFrom:
                - configMapRef:
                    name: pgdump-config
              command:
                - /bin/sh
                - -c
                - pg_dump --clean --blob --if-exists -F d -Z 9 -f /pg_dump/vaultwarden_$(date +'%d-%m-%Y')
              volumeMounts:
                - name: pg-dump-volume
                  mountPath: /pg_dump

          containers:
            - name: borg
              image: debian:latest
              imagePullPolicy: IfNotPresent
              command:
                  - /bin/sh
                  - -c
                  - |
                    apt-get update && apt-get install -y borgbackup
                    borg --version
            - name: restic
              image: restic/restic:latest
              imagePullPolicy: IfNotPresent
              envFrom:
                - configMapRef:
                    name: vaultwarden-config
                - configMapRef:
                    name: restic-config
                - secretRef:
                    name: restic-secret
                - secretRef:
                    name: healthchecks-secret
              command:
                  - /bin/sh
                  - -c
                  - |
                    umask 077

                    apk add curl fish vim

                    ssh -V
                    restic version
                    curl --version

                    chmod 700 /root/.ssh/
                    ssh-keyscan -p 23 -f /root/.ssh/hosts >> /root/.ssh/known_hosts

                    # debug ssh connection
                    #ssh -vvvv storagebox

                    #sleep infinity

                    curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/start

                    # Kubernetes, by default, uses the Pod name as the hostname, and since Pod names are random "no parent snapshot found, will read all files" occur as restic snapshots are distinguished by both path and host.
                    restic backup --host tryrocket.cloud --tag daily --tag vaultwarden:$VAULTWARDEN_VERSION /pg_dump /data
                    curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?

                    restic check --read-data-subset 1/7
                    curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?

                    restic forget --keep-daily 30 --keep-monthly 3 --keep-yearly 1 --prune
                    curl -fsS -m 10 --retry 5 https://hc-ping.com/$HC_UUID/$?
              volumeMounts:
                - name: vaultwarden-rwx-storage
                  mountPath: /data
                  readOnly: true
                - name: vaultwarden-hetzner-subaccount-ssh-privatekey
                  mountPath: /root/.ssh/id_ed25519
                  readOnly: true
                  subPath: id_ed25519
                - name: vaultwarden-hetzner-subaccount-ssh-config
                  mountPath: /root/.ssh/config
                  readOnly: true
                  subPath: config
                - name: vaultwarden-hetzner-subaccount-ssh-hosts
                  mountPath: /root/.ssh/hosts
                  readOnly: true
                  subPath: hosts
                - name: pg-dump-volume
                  mountPath: /pg_dump
                  readOnly: true
          volumes:
            - name: vaultwarden-rwx-storage
              persistentVolumeClaim:
                claimName: vaultwarden-rwx-pvc
            - name: vaultwarden-hetzner-subaccount-ssh-privatekey
              secret:
                secretName: hetzner-subaccount-ssh-secret
                items:
                  - key: ssh-privatekey
                    path: id_ed25519
                defaultMode: 384
            - name: vaultwarden-hetzner-subaccount-ssh-config
              secret:
                secretName: hetzner-subaccount-ssh-secret
                items:
                  - key: ssh-config
                    path: config
                defaultMode: 384
            - name: vaultwarden-hetzner-subaccount-ssh-hosts
              secret:
                secretName: hetzner-subaccount-ssh-secret
                items:
                  - key: ssh-hosts
                    path: hosts
                defaultMode: 384
            - name: pg-dump-volume
              emptyDir: {}

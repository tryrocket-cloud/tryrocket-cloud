# Production overlay
#
# External dependencies:
#   - HashiCorp Vault
#   - Postgres Database
#   - Storage

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - namespace.yaml
  - ../../base/vaultwarden
  - ./backup
  - postgres-external-secret.yaml
  - vaultwarden-external-secret.yaml
  - pvc-rwx.yaml
  - pv-rwx.yaml
namespace: vaultwarden

# https://github.com/dani-garcia/vaultwarden/releases
images:
  - name: vaultwarden/server:latest
    newTag: 1.32.0
    
#    1.32.0
# TODO: use kubectl describe deploy/vaultwarden and get the image version

configMapGenerator:
  - name: vaultwarden-config
    literals:
      - VAULTWARDEN_VERSION=1.32.0
    behavior: merge
# TODO: remove VAULTWARDEN_VERSION use kubectl describe deploy/vaultwarden and get the image version

patches:
  - target:
      kind: Deployment
      name: vaultwarden
    path: patch-deployment.yaml


# TODO: simplify DATABASE_USERNAME and DATABASE_PASSWORD by using just username and password form vaultwarden-postgres-secret
# TODO: refactor DATABASE_URL somehow to be env

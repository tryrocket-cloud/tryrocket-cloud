apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  #- namespace.yaml
  - ../../base
  #- ../../base-backup
  #- postgres-external-secret.yaml
  #- vaultwarden-external-secret.yaml
  #- pvc.yaml
  #- pv.yaml

namespace: vaultwarden

# https://github.com/dani-garcia/vaultwarden/releases
images:
  - name: vaultwarden/server:latest
    newTag: 1.32.0
# TODO: use kubectl describe deploy/vaultwarden and get the image version

configMapGenerator:
  - name: vaultwarden-config
    literals:
      - VAULTWARDEN_VERSION=1.32.0
      - DOMAIN=https://vaultwarden.tryrocket.cloud
      - DATABASE_URL=postgresql://$(DATABASE_USERNAME):$(DATABASE_PASSWORD)@postgres.postgres-16.svc.cluster.local:5432/vaultwarden
    behavior: merge
# TODO: remove VAULTWARDEN_VERSION use kubectl describe deploy/vaultwarden and get the image version

patches:
  - target:
      kind: Deployment
      name: vaultwarden
    patch: |
      - op: add
        path: /spec/template/spec/containers/0/
        value:
          volumeMounts:
            - name: vaultwarden-storage
              mountPath: /data
            - name: vaultwarden-rwx-storage
              mountPath: /data-rwx



#      - op: add
#        path: /spec/template/spec
#        value: |
#          volumes:
#            - name: vaultwarden-storage
#              persistentVolumeClaim:
#                claimName: vaultwarden-pvc
#            - name: vaultwarden-rwx-storage
#              persistentVolumeClaim:
#                claimName: vaultwarden-rwx-pvc

#      - op: add
#        path: /spec/template/spec/containers/0/env/-
#        value: |
#          name: DATABASE_USERNAME
#          valueFrom:
#            secretKeyRef:
#              key: username
#              name: vaultwarden-postgres-secret
#          name: DATABASE_PASSWORD
#          valueFrom:
#            secretKeyRef:
#              key: password
#              name: vaultwarden-postgres-secret

#      - op: add
#        path: /spec/template/spec/containers/0/envFrom/-
#        value: |
#          - secretRef:
#              name: vaultwarden-secret

# TODO: simplify by using just username and password form vaultwarden-postgres-secret


#  - target:
#      kind: Deployment
#      name: vaultwarden
#    patch: |
#      - op: add
#        path: /metadata/annotations/secret.reloader.stakater.com~1reload
#        value: "vaultwarden-postgres-secret"
apiVersion: apps/v1
kind: Deployment
metadata:
  name: vaultwarden
spec:
  template:
    spec:
      initContainers:
        - name: restore-from-s3-eu-central-1-restic-backup
          image: ghcr.io/tryrocket-cloud/tryrocket-cloud:backup
          imagePullPolicy: Always
          envFrom:
            - secretRef:
                name: ionos-s3-restic-2-secret
          command:
              - /bin/sh
              - -c
              - |
                restic restore latest --target .
          volumeMounts:
            - name: vaultwarden-storage
              mountPath: /data
              readOnly: false
            - name: pg-dump-volume
              mountPath: /pg_dump
              readOnly: false

        - name: pg-retore
          image: postgres:16.3-alpine
          imagePullPolicy: Always
          envFrom:
            - configMapRef:
                name: postgres-config
          command:
              - /bin/sh
              - -c
              - |
                pg_isready

                until pg_isready; do
                  echo "Waiting for PostgreSQL to be ready..."
                  sleep 2  # Wait for 2 seconds before checking again
                done

                pg_restore -U u-vaultwarden -d vaultwarden /pg_dump/vaultwarden_*
          volumeMounts:
            - name: pg-dump-volume
              mountPath: /pg_dump
              readOnly: true
      volumes:
        - name: vaultwarden-storage
          emptyDir: {}
        - name: pg-dump-volume
          emptyDir: {}
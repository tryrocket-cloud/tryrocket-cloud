apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup
spec:
  suspend: false
  schedule: "*/30 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup
          containers:
          # TODO: custom docker image
          - name: ansible-runner
            image: quay.io/ansible/ansible-runner:latest
            args: 
              - /bin/sh
              - -c
              - |
                curl -sSL -o argocd-linux-amd64 "https://github.com/argoproj/argo-cd/releases/download/v2.12.0/argocd-linux-amd64"
                chmod +x argocd-linux-amd64
                mv argocd-linux-amd64 /usr/local/bin/argocd
                #argocd version
                pip3 install kubernetes &&
                ansible-galaxy collection install kubernetes.core &&
                ansible-playbook /playbooks/my-playbook.yml
                ls -la /data
            volumeMounts:
            - name: playbook-volume
              mountPath: /playbooks
            - name: kubeconfig
              mountPath: /etc/kubeconfig
            - name: vaultwarden-storage
              mountPath: /data
          restartPolicy: Never
          volumes:
          - name: playbook-volume
            configMap:
              name: ansible-playbook-configmap
          - name: kubeconfig
            configMap:
              name: kubeconfig-backup-sa
        - name: vaultwarden-storage
          persistentVolumeClaim:
            claimName: vaultwarden-pvc
      backoffLimit: 0  # Optional: This will stop retrying the job if it fails
          volumeMounts:

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ansible-playbook-configmap
data:
  my-playbook.yml: |
    ---
    - name: Backup Vaultwarden
      hosts: localhost
      gather_facts: false
      collections:
        - kubernetes.core

      tasks:
        - name: Ensure the message is echoed
          command: echo "Hello, World!"

        - name: Disable ArgoCD auto-sync
          command: argocd app set vaultwarden --sync-policy none --server argocd.tryrocket.cloud --insecure --auth-token eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJhcmdvY2QiLCJzdWIiOiJhZG1pbjphcGlLZXkiLCJleHAiOjE3MjQzMzU2NzYsIm5iZiI6MTcyMzQ3MTY3NiwiaWF0IjoxNzIzNDcxNjc2LCJqdGkiOiJ0ZXN0In0.aNNlFEcvL84fPUv-wvkw6DCet1BmlYTormJqKVlCfTM

        - name: Scale down replicas of a deployment
          k8s:
            kubeconfig: /etc/kubeconfig/kubeconfig.yaml
            api_version: apps/v1
            kind: Deployment
            name: vaultwarden
            namespace: vaultwarden
            state: present
            definition:
              spec:
                replicas: 0

        - name: Enable ArgoCD auto-sync
          command: argocd app set vaultwarden --sync-policy automated --self-heal --auto-prune --server argocd.tryrocket.cloud --insecure --auth-token eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJhcmdvY2QiLCJzdWIiOiJhZG1pbjphcGlLZXkiLCJleHAiOjE3MjQzMzU2NzYsIm5iZiI6MTcyMzQ3MTY3NiwiaWF0IjoxNzIzNDcxNjc2LCJqdGkiOiJ0ZXN0In0.aNNlFEcvL84fPUv-wvkw6DCet1BmlYTormJqKVlCfTM

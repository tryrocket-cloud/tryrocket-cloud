apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup
spec:
  suspend: false
  schedule: "*/30 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup
          containers:
          # TODO: custom docker image
          - name: ansible-runner
            image: quay.io/ansible/ansible-runner:latest
            args: 
              - /bin/sh
              - -c
              - |
                curl -sSL -o argocd-linux-amd64 "https://github.com/argoproj/argo-cd/releases/download/v2.12.0/argocd-linux-amd64"
                chmod +x argocd-linux-amd64
                mv argocd-linux-amd64 /usr/local/bin/argocd
                #argocd version
                pip3 install kubernetes &&
                ansible-galaxy collection install kubernetes.core &&
                ansible-playbook /playbooks/my-playbook.yml
            volumeMounts:
            - name: playbook-volume
              mountPath: /playbooks
            - name: kubeconfig
              mountPath: /etc/kubeconfig
          restartPolicy: Never
          volumes:
          - name: playbook-volume
            configMap:
              name: ansible-playbook-configmap
          - name: kubeconfig
            configMap:
              name: kubeconfig-backup-sa

      backoffLimit: 0  # Optional: This will stop retrying the job if it fails

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ansible-playbook-configmap
data:
  my-playbook.yml: |
    ---
    - name: Backup Vaultwarden
      hosts: localhost
      gather_facts: false
      collections:
        - kubernetes.core

      tasks:
        - name: Ensure the message is echoed
          command: echo "Hello, World!"

        - name: Disable ArgoCD auto-sync
          command: argocd app set vaultwarden --sync-policy none --server argocd.tryrocket.cloud --insecure --auth-token eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJhcmdvY2QiLCJzdWIiOiJhZG1pbjphcGlLZXkiLCJleHAiOjE3MjQzMzU2NzYsIm5iZiI6MTcyMzQ3MTY3NiwiaWF0IjoxNzIzNDcxNjc2LCJqdGkiOiJ0ZXN0In0.aNNlFEcvL84fPUv-wvkw6DCet1BmlYTormJqKVlCfTM

        - name: Scale down replicas of a deployment
          k8s:
            kubeconfig: /etc/kubeconfig/kubeconfig.yaml
            api_version: apps/v1
            kind: Deployment
            name: vaultwarden
            namespace: vaultwarden
            state: present
            definition:
              spec:
                replicas: 0

        - name: Wait for pods to terminate
          k8s_info:
            kubeconfig: /etc/kubeconfig/kubeconfig.yaml
            api_version: v1
            kind: Pod
            namespace: vaultwarden
            label_selectors:
              - app=vaultwarden
          register: deployment_info

        - name: Debug deployment_info
          debug:
            var: deployment_info
#          until: deployment_info.resources[0].status.replicas == 0
#          retries: 10
#          delay: 6
#          failed_when: deployment_info.resources[0].status.replicas != 0

        - name: Create a new job with the attached volume
          k8s:
            kubeconfig: /etc/kubeconfig/kubeconfig.yaml
            api_version: batch/v1
            kind: Job
            namespace: vaultwarden
            definition:
              apiVersion: batch/v1
              kind: Job
              metadata:
                name: vaultwarden-backup
              spec:
                template:
                  spec:
                    containers:
                    - name: busibox
                      image: busibox
                      args: 
                        - /bin/sh
                        - -c
                        - |
                          ls -la /data
                      volumeMounts:
                      - name: vaultwarden-storage
                        mountPath: /data
                    restartPolicy: OnFailure
                    volumes:
                      - name: vaultwarden-storage
                        persistentVolumeClaim:
                          claimName: vaultwarden-pvc

        - name: Enable ArgoCD auto-sync
          command: argocd app set vaultwarden --sync-policy automated --self-heal --auto-prune --server argocd.tryrocket.cloud --insecure --auth-token eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJhcmdvY2QiLCJzdWIiOiJhZG1pbjphcGlLZXkiLCJleHAiOjE3MjQzMzU2NzYsIm5iZiI6MTcyMzQ3MTY3NiwiaWF0IjoxNzIzNDcxNjc2LCJqdGkiOiJ0ZXN0In0.aNNlFEcvL84fPUv-wvkw6DCet1BmlYTormJqKVlCfTM

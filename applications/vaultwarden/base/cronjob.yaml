apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup
spec:
  schedule: "*/5 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: ansible-runner
            image: quay.io/ansible/ansible-runner:latest
            args: 
              - /bin/sh
              - -c
              - |
                ansible-galaxy collection install argoproj-labs.argocd && 
                ansible-playbook /playbooks/my-playbook.yml
            volumeMounts:
            - name: playbook-volume
              mountPath: /playbooks
          restartPolicy: Never
          volumes:
          - name: playbook-volume
            configMap:
              name: ansible-playbook-configmap
      backoffLimit: 0  # Optional: This will stop retrying the job if it fails

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ansible-playbook-configmap
data:
  my-playbook.yml: |
    ---
    - name: Backup Vaultwarden
      hosts: localhost
      collections:
        - argoproj-labs.argocd
      tasks:
        - name: Ensure the message is echoed
          command: echo "Hello, World!"

    - name: Disable auto-sync for the application
      argoproj-labs.argocd.argocd_app:
        name: vaultwarden
        project: default
        repo_url: https://github.com/tryrocket-cloud/tryrocket-cloud.git
        path: applications/vaultwarden/overlays/production
        dest_server: https://192.168.178.101:6443
        dest_namespace: vaultwarden
        state: present
        sync_policy: null
        argocd_server: https://argocd.tryrocket.cloud
        username: admin
        password: mypassword
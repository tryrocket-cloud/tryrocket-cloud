apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup
spec:
  schedule: "*/30 * * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          # TODO: custom docker image
          - name: ansible-runner
            image: quay.io/ansible/ansible-runner:latest
            args: 
              - /bin/sh
              - -c
              - |
                curl -sSL -o argocd-linux-amd64 "https://github.com/argoproj/argo-cd/releases/download/v2.12.0/argocd-linux-amd64"
                chmod +x argocd-linux-amd64
                mv argocd-linux-amd64 /usr/local/bin/argocd
                #argocd version
                pip3 install kubernetes &&
                ansible-galaxy collection install kubernetes.core &&
                ansible-playbook /playbooks/my-playbook.yml
            volumeMounts:
            - name: playbook-volume
              mountPath: /playbooks
          restartPolicy: Never
          volumes:
          - name: playbook-volume
            configMap:
              name: ansible-playbook-configmap
      backoffLimit: 0  # Optional: This will stop retrying the job if it fails

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ansible-playbook-configmap
data:
  my-playbook.yml: |
    ---
    - name: Backup Vaultwarden
      hosts: localhost
      gather_facts: false
      collections:
        - kubernetes.core

      tasks:
        - name: Ensure the message is echoed
          command: echo "Hello, World!"

        - name: Disable ArgoCD auto-sync
          command: argocd app set vaultwarden --sync-policy none --server argocd.tryrocket.cloud --insecure --auth-token eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJhcmdvY2QiLCJzdWIiOiJhZG1pbjphcGlLZXkiLCJleHAiOjE3MjQzMzU2NzYsIm5iZiI6MTcyMzQ3MTY3NiwiaWF0IjoxNzIzNDcxNjc2LCJqdGkiOiJ0ZXN0In0.aNNlFEcvL84fPUv-wvkw6DCet1BmlYTormJqKVlCfTM

        - name: Kubectl scale down replica
          command: kubectl scale deployment vaultwarden --replicas=0 -n vaultwarden

        - name: Enable ArgoCD auto-sync
          command: argocd app set vaultwarden --sync-policy automated --self-heal --auto-prune --server argocd.tryrocket.cloud --insecure --auth-token eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJhcmdvY2QiLCJzdWIiOiJhZG1pbjphcGlLZXkiLCJleHAiOjE3MjQzMzU2NzYsIm5iZiI6MTcyMzQ3MTY3NiwiaWF0IjoxNzIzNDcxNjc2LCJqdGkiOiJ0ZXN0In0.aNNlFEcvL84fPUv-wvkw6DCet1BmlYTormJqKVlCfTM

#        - name: Disable auto-sync in the Argo CD application
#          kubernetes.core.k8s:
#            api_version: argoproj.io/v1alpha1
#            kind: Application
#            name: vaultwarden
#            namespace: argocd
#            state: present
#            definition:
#              spec:
#                syncPolicy: {}
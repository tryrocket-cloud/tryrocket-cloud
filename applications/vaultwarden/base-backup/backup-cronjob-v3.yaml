apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup
spec:
  suspend: false
  schedule: "5 1 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          restartPolicy: Never
          serviceAccountName: backup-sa
          initContainers:
            - name: pg-dump
              image: postgres:16
              imagePullPolicy: IfNotPresent
              env:
                - name: PGUSER
                  valueFrom:
                    secretKeyRef:
                      name: vaultwarden-postgres-secret
                      key: username
                - name: PGPASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: vaultwarden-postgres-secret
                      key: password
              envFrom:
                - configMapRef:
                    name: pgdump-config
              command:
                - /bin/sh
                - -c
                - |
                  # TODO: choose one

                  #echo Hello

                  # Plain Text Format
                  #pg_dump -F p -f /pg_dump/vaultwarden_$(date +'%d-%m-%Y')_plaintext.sql

                  # Directory
                  pg_dump -F d -Z 9 -f /pg_dump/vaultwarden_$(date +'%d-%m-%Y')

                  # Tar
                  #pg_dump -F t -Z 9 -v -f /pg_dump/vaultwarden_$(date +'%d-%m-%Y').tar
                  #pg_dump -F t -f /pg_dump/vaultwarden_$(date +'%d-%m-%Y')_without_compression.tar
              volumeMounts:
                - name: pg-dump-volume
                  mountPath: /pg_dump

          containers:
            - name: restic
              image: restic/restic
              imagePullPolicy: IfNotPresent
              envFrom:
                - configMapRef:
                    name: restic-config
                - secretRef:
                    name: restic-secret
                - configMapRef:
                    name: healthchecks-config
                - secretRef:
                    name: healthchecks-secret
              command:
                  - /bin/sh
                  - -c
                  - |
                    echo "Verify ssh config"
                    ls -la /root/.ssh/
                    cat /root/.ssh/config
                    
                    echo "known_hosts"
                    ssh-keyscan -f /root/.ssh/hosts >> /root/.ssh/known_hosts
                    #ssh-keyscan -p 23 your-storagebox.de -o /root/.ssh/known_hosts
                    cat /root/.ssh/known_hosts
                    
                    ls -la /root/.ssh/

                   
                    #ls -la /root/.ssh/

                    #ssh-keyscan -p 23 uXXXXXX.your-storagebox.de >> /root/.ssh/known_hosts
                    #cp /root/.ssh/ided25519 /root/.ssh/id_ed25519
                    #chmod 700 /root/.ssh/ && chmod 600 /root/.ssh/id_ed25519 # && chmod 644 /root/.ssh/known_hosts

                    #curl -fsS -m $HC_TIMEOUT --retry $HC_RETRY https://hc-ping.com/$HC_UUID/start

                    #cat /pg_dump/vaultwarden_$(date +'%d-%m-%Y').sql
                    #ls -la /pg_dump/vaultwarden_$(date +'%d-%m-%Y')

                    #ls -ls /root/.ssh/
                    #cat /root/.ssh/config
                    #cat /root/.ssh/id_ed25519

                    #restic backup --dry-run /pg_dump /data
                    #restic backup /pg_dump /data > /var/log/restic/backup.log 2>&1
                    #curl -fsS -m $HC_TIMEOUT --retry $HC_RETRY --data-binary @/var/log/restic/backup.log https://hc-ping.com/$HC_UUID/$?

                    #restic check > /var/log/restic/check.log 2>&1
                    #curl -fsS -m $HC_TIMEOUT --retry $HC_RETRY --data-binary @/var/log/restic/check.log https://hc-ping.com/$HC_UUID/$?

                    #restic forget --dry-run
                    #restic forget > /var/log/restic/forget.log 2>&1
                    #curl -fsS -m $HC_TIMEOUT --retry $HC_RETRY --data-binary @/var/log/restic/forget.log https://hc-ping.com/$HC_UUID/$?
              volumeMounts:
                - name: vaultwarden-rwx-storage
                  mountPath: /data
                  readOnly: true
                - name: vaultwarden-hetzner-subaccount-ssh-privatekey
                  mountPath: /root/.ssh/id_ed25519
                  readOnly: true
                  subPath: id_ed25519
                - name: vaultwarden-hetzner-subaccount-ssh-config
                  mountPath: /root/.ssh/config
                  readOnly: true
                  subPath: config
                - name: vaultwarden-hetzner-subaccount-ssh-hosts
                  mountPath: /root/.ssh/hosts
                  readOnly: true
                  subPath: hosts
#                - name: vaultwarden-hetzner-subaccount-ssh-known-hosts
#                  mountPath: /root/.ssh/known_hosts
#                  readOnly: true
#                  subPath: known_hosts
                - name: pg-dump-volume
                  mountPath: /pg_dump
                  readOnly: true
                - name: dot-ssh-volume
                  mountPath: /root/.ssh/
          volumes:
            - name: vaultwarden-rwx-storage
              persistentVolumeClaim:
                claimName: vaultwarden-rwx-pvc
            - name: vaultwarden-hetzner-subaccount-ssh-privatekey
              secret:
                secretName: hetzner-subaccount-ssh-privatekey
                items:
                  - key: ssh-privatekey
                    path: id_ed25519
                defaultMode: 384
            - name: vaultwarden-hetzner-subaccount-ssh-config
              configMap:
                name: hetzner-subaccount-ssh-config
                defaultMode: 384
            - name: vaultwarden-hetzner-subaccount-ssh-hosts
              configMap:
                name: hetzner-subaccount-ssh-hosts
                defaultMode: 384
#            - name: vaultwarden-hetzner-subaccount-ssh-config
#              secret:
#                secretName: hetzner-subaccount-ssh-config
#                items:
#                  - key: config
#                    path: config
#                defaultMode: 384
#            - name: vaultwarden-hetzner-subaccount-ssh-known-hosts
#              secret:
#                secretName: hetzner-subaccount-ssh-known-hosts
#                items:
#                  - key: known_hosts
#                    path: known_hosts
#                defaultMode: 384
            - name: pg-dump-volume
              emptyDir: {}
            - name: dot-ssh-volume
              emptyDir: {}
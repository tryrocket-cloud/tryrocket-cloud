name: Update Vaultwarden

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-for-new-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

#      - name: Install yq
#        run: apt-get update && apt-get -y install yq
      - name: Install yq
        run: |
          VERSION=v4.44.3
          wget https://github.com/mikefarah/yq/releases/download/$VERSION/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Get Latest Vaultwarden Release
        id: get_latest_release
        run: |
          latest_version=$(curl --silent "https://api.github.com/repos/dani-garcia/vaultwarden/releases/latest" | jq -r .tag_name)
          echo "latest_version=${latest_version}" >> $GITHUB_ENV
          echo "Latest Vaultwarden release is ${latest_version}"

      - name: Get current Vaultwarden version
        id: get_current_tag
        run: |
          current_tag=$(yq '.images[0].newTag' applications/vaultwarden/overlays/production/kustomization.yaml)
          echo "current_tag=${current_tag}" >> $GITHUB_ENV
          echo "Current Vaultwarden tag is ${current_tag}"

      - name: Check if Update is Needed
        id: check_update
        run: |
          if [ "${{ env.latest_version }}" = "${{ env.current_tag }}" ]; then
            echo "No update needed"
            echo "update_needed=false" >> $GITHUB_ENV
          else
            echo "Update needed"
            echo "update_needed=true" >> $GITHUB_ENV
          fi

      - name: Update kustomization.yaml
        if: env.update_needed == 'true'
        run: |
          yq eval '.images[0].newTag = "${{ env.latest_version }}"' -i applications/vaultwarden/overlays/production/kustomization.yaml
          rm applications/vaultwarden/overlays/production/kustomization.yaml
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          #git log

          echo ---
          git status
          echo ---

          git checkout -b update-vaultwarden-${{ env.latest_version }}
          git status
          echo ---

          git add .
          git status
          echo ---
          git commit -m "Update Vaultwarden to ${{ env.latest_version }}"
          git status
          echo ---
          git show --name-status update-vaultwarden-${{ env.latest_version }}
          echo ---
          git tag vaultwarden-${{ env.latest_version }}
          echo ---
          git push origin update-vaultwarden-${{ env.latest_version }}

      - name: Create Pull Request
        if: env.update_needed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update Vaultwarden to ${{ env.latest_version }}"
          base: main
          branch: update-vaultwarden-${{ env.latest_version }}
          title: "Update Vaultwarden to ${{ env.latest_version }}"
          body: "This PR updates the Vaultwarden version to the latest release: ${{ env.latest_version }}."
          labels: |
            vaultwarden
            update
